{% extends "base.html" %}

{% block content %}
<header style="text-align: center; margin-bottom: 3rem;">
    <h1
        style="font-size: 3rem; margin-bottom: 0.5rem; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        Bienvenido al Futuro</h1>
    <p style="color: #aaa; font-size: 1.2rem;">Descubre la mejor tecnolog√≠a y moda</p>
</header>

<section>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0; border-left: 4px solid var(--secondary-color); padding-left: 10px;">Productos Destacados
        </h2>

        <form action="/" method="GET" class="search-container" style="margin-bottom: 0; padding: 0.5rem 1rem;">
            <input type="text" name="q" placeholder="Buscar..." class="search-input"
                value="{{ request.args.get('q', '') }}">
            <select name="category" class="search-select" onchange="this.form.submit()">
                <option value="">Todas las Categor√≠as</option>
                {% for cat in categories %}
                <option value="{{ cat.slug }}" {% if request.args.get('category')==cat.slug %}selected{% endif %}>{{
                    cat.nombre }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn" style="padding: 5px 15px;">üîç</button>
        </form>
    </div>

    <div class="product-grid">
        {% for product in products %}
        <div class="glass-panel product-card">
            <!-- Placeholder image logic if no real image -->
            {% if product.imagenes and product.imagenes|length > 0 %}
            <img src="{{ product.imagenes[0] }}" alt="{{ product.nombre }}" class="product-img">
            {% else %}
            <div class="product-img"
                style="display: flex; align-items: center; justify-content: center; background: #222;">
                <span>Sin Imagen</span>
            </div>
            {% endif %}

            <div class="product-title">{{ product.nombre }}</div>
            <div class="product-price">${{ product.precio / 100 }} {{ product.moneda }}</div>
            <p class="product-description">{{ product.descripcion }}</p>

            <div style="margin-top: 1rem;">
                <span
                    style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">{{
                    product.categoria.nombre }}</span>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <a href="/product/{{ product._id }}" class="btn" style="flex: 1; text-align: center;">Ver Detalles</a>
                <button onclick="addToCart('{{ product._id }}')" class="btn btn-secondary"
                    style="width: 40px; display: flex; align-items: center; justify-content: center; padding: 0; cursor: pointer;">üõí</button>
            </div>
        </div>
        {% else %}
        <p>No se encontraron productos.</p>
        {% endfor %}
    </div>
</section>

<script>
    // AJAX Add to Cart
    async function addToCart(productId) {
        try {
            const response = await fetch(`/cart/add/${productId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }

            const data = await response.json();
            if (data.success) {
                // Show toast
                const toast = document.createElement('div');
                toast.textContent = '¬°Producto agregado al carrito!';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.background = 'var(--secondary-color)';
                toast.style.color = '#000';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '8px';
                toast.style.zIndex = '1000';
                toast.style.fontWeight = 'bold';
                toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 3000);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
        }
    }

    // Hover Effect
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.product-card');

        cards.forEach(card => {
            card.addEventListener('mousemove', function (e) {
                const rect = this.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                this.style.setProperty('--mouse-x', `${x}%`);
                this.style.setProperty('--mouse-y', `${y}%`);
            });

            // Resetear posici√≥n cuando el mouse sale
            card.addEventListener('mouseleave', function () {
                this.style.setProperty('--mouse-x', '50%');
                this.style.setProperty('--mouse-y', '50%');
            });
        });
    });
</script>
{% endblock %}